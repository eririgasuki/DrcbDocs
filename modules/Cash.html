<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>现金模块 | 东莞农商云柜台项目 C 端文档</title>
    <meta name="description" content="快速熟悉框架配置,进入状态敏捷开发">
    
    
    <link rel="preload" href="/DrcbDocs/assets/css/0.styles.d15396c6.css" as="style"><link rel="preload" href="/DrcbDocs/assets/js/app.5f05759d.js" as="script"><link rel="preload" href="/DrcbDocs/assets/js/22.afd303ac.js" as="script"><link rel="prefetch" href="/DrcbDocs/assets/js/10.ed58935d.js"><link rel="prefetch" href="/DrcbDocs/assets/js/11.98ffa94a.js"><link rel="prefetch" href="/DrcbDocs/assets/js/12.42913104.js"><link rel="prefetch" href="/DrcbDocs/assets/js/13.4aab5801.js"><link rel="prefetch" href="/DrcbDocs/assets/js/14.16f79651.js"><link rel="prefetch" href="/DrcbDocs/assets/js/15.99c936f7.js"><link rel="prefetch" href="/DrcbDocs/assets/js/16.59fc46d2.js"><link rel="prefetch" href="/DrcbDocs/assets/js/17.71265d47.js"><link rel="prefetch" href="/DrcbDocs/assets/js/18.47a6a9d1.js"><link rel="prefetch" href="/DrcbDocs/assets/js/19.84efe2a2.js"><link rel="prefetch" href="/DrcbDocs/assets/js/2.5f8435fb.js"><link rel="prefetch" href="/DrcbDocs/assets/js/20.df6be6f5.js"><link rel="prefetch" href="/DrcbDocs/assets/js/21.d5dab7be.js"><link rel="prefetch" href="/DrcbDocs/assets/js/23.06388ba0.js"><link rel="prefetch" href="/DrcbDocs/assets/js/24.14936f27.js"><link rel="prefetch" href="/DrcbDocs/assets/js/25.c0c849f4.js"><link rel="prefetch" href="/DrcbDocs/assets/js/26.84effea4.js"><link rel="prefetch" href="/DrcbDocs/assets/js/27.e19cb001.js"><link rel="prefetch" href="/DrcbDocs/assets/js/28.f40dc1cc.js"><link rel="prefetch" href="/DrcbDocs/assets/js/29.c3f3e2bd.js"><link rel="prefetch" href="/DrcbDocs/assets/js/3.c54c861c.js"><link rel="prefetch" href="/DrcbDocs/assets/js/30.24108429.js"><link rel="prefetch" href="/DrcbDocs/assets/js/31.5e850f60.js"><link rel="prefetch" href="/DrcbDocs/assets/js/32.3238fab5.js"><link rel="prefetch" href="/DrcbDocs/assets/js/33.abcd4c94.js"><link rel="prefetch" href="/DrcbDocs/assets/js/34.ee334abf.js"><link rel="prefetch" href="/DrcbDocs/assets/js/35.f227d0cf.js"><link rel="prefetch" href="/DrcbDocs/assets/js/36.bf7bd705.js"><link rel="prefetch" href="/DrcbDocs/assets/js/37.b6f873bf.js"><link rel="prefetch" href="/DrcbDocs/assets/js/38.33f7986e.js"><link rel="prefetch" href="/DrcbDocs/assets/js/39.a24c6744.js"><link rel="prefetch" href="/DrcbDocs/assets/js/4.411d1756.js"><link rel="prefetch" href="/DrcbDocs/assets/js/40.d88c3c43.js"><link rel="prefetch" href="/DrcbDocs/assets/js/41.345c7f3c.js"><link rel="prefetch" href="/DrcbDocs/assets/js/42.4c31f71d.js"><link rel="prefetch" href="/DrcbDocs/assets/js/43.fffcbf7c.js"><link rel="prefetch" href="/DrcbDocs/assets/js/44.b60bcdbc.js"><link rel="prefetch" href="/DrcbDocs/assets/js/45.79d73d78.js"><link rel="prefetch" href="/DrcbDocs/assets/js/46.a2b28eee.js"><link rel="prefetch" href="/DrcbDocs/assets/js/47.6e6fecca.js"><link rel="prefetch" href="/DrcbDocs/assets/js/48.564854ce.js"><link rel="prefetch" href="/DrcbDocs/assets/js/49.9aa021f1.js"><link rel="prefetch" href="/DrcbDocs/assets/js/5.af2d245b.js"><link rel="prefetch" href="/DrcbDocs/assets/js/50.209d99cb.js"><link rel="prefetch" href="/DrcbDocs/assets/js/51.1eca88cc.js"><link rel="prefetch" href="/DrcbDocs/assets/js/52.c5b9e11e.js"><link rel="prefetch" href="/DrcbDocs/assets/js/53.6b146261.js"><link rel="prefetch" href="/DrcbDocs/assets/js/54.a85d2fe3.js"><link rel="prefetch" href="/DrcbDocs/assets/js/55.a0c23627.js"><link rel="prefetch" href="/DrcbDocs/assets/js/56.e1ec1b64.js"><link rel="prefetch" href="/DrcbDocs/assets/js/57.c1fc0f69.js"><link rel="prefetch" href="/DrcbDocs/assets/js/58.bb310962.js"><link rel="prefetch" href="/DrcbDocs/assets/js/59.c9ae8670.js"><link rel="prefetch" href="/DrcbDocs/assets/js/6.ea166292.js"><link rel="prefetch" href="/DrcbDocs/assets/js/60.41960d7a.js"><link rel="prefetch" href="/DrcbDocs/assets/js/61.cd95a9bc.js"><link rel="prefetch" href="/DrcbDocs/assets/js/62.e1848158.js"><link rel="prefetch" href="/DrcbDocs/assets/js/63.47dcd60b.js"><link rel="prefetch" href="/DrcbDocs/assets/js/64.11543628.js"><link rel="prefetch" href="/DrcbDocs/assets/js/65.94b79de3.js"><link rel="prefetch" href="/DrcbDocs/assets/js/66.c0a52390.js"><link rel="prefetch" href="/DrcbDocs/assets/js/7.62807c4b.js"><link rel="prefetch" href="/DrcbDocs/assets/js/8.26a742b7.js"><link rel="prefetch" href="/DrcbDocs/assets/js/9.4f33eddf.js">
    <link rel="stylesheet" href="/DrcbDocs/assets/css/0.styles.d15396c6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/DrcbDocs/" class="home-link router-link-active"><!----> <span class="site-name">东莞农商云柜台项目 C 端文档</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/DrcbDocs/" class="nav-link">Home</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/DrcbDocs/" class="nav-link">Home</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>快速开始</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>C端功能模块</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/DrcbDocs/modules/" class="sidebar-link">模块概述</a></li><li><a href="/DrcbDocs/modules/IDCard.html" class="sidebar-link">身份证模块</a></li><li><a href="/DrcbDocs/modules/BankCard.html" class="sidebar-link">银行卡模块</a></li><li><a href="/DrcbDocs/modules/Passbook.html" class="sidebar-link">存折模块</a></li><li><a href="/DrcbDocs/modules/PinKeypad.html" class="sidebar-link">密码模块</a></li><li><a href="/DrcbDocs/modules/Document.html" class="sidebar-link">文档模块</a></li><li><a href="/DrcbDocs/modules/Deposit.html" class="sidebar-link">票据模块</a></li><li><a href="/DrcbDocs/modules/Receipt.html" class="sidebar-link">凭条模块</a></li><li><a href="/DrcbDocs/modules/Cash.html" class="active sidebar-link">现金模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DrcbDocs/modules/Cash.html#cashinconfirmnew2-机具存款页面" class="sidebar-link">CashInConfirmNew2 机具存款页面</a></li><li class="sidebar-sub-header"><a href="/DrcbDocs/modules/Cash.html#cashoutayo-机具取款页面" class="sidebar-link">CashOutAyo 机具取款页面</a></li></ul></li><li><a href="/DrcbDocs/modules/HighCamera.html" class="sidebar-link">高拍仪模块</a></li><li><a href="/DrcbDocs/modules/FingerPrinter.html" class="sidebar-link">指纹仪模块</a></li><li><a href="/DrcbDocs/modules/UKey.html" class="sidebar-link">U盾模块</a></li><li><a href="/DrcbDocs/modules/SignatureTablet.html" class="sidebar-link">签字版模块</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>深入理解C端框架</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>编码规范</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="cashinconfirmnew2-机具存款页面"><a href="#cashinconfirmnew2-机具存款页面" aria-hidden="true" class="header-anchor">#</a> CashInConfirmNew2 机具存款页面</h2> <h3 id="简易流程图"><a href="#简易流程图" aria-hidden="true" class="header-anchor">#</a> 简易流程图</h3> <p><img src="/DrcbDocs/assets/img/CashInConfirmNew1.5cce3782.png" alt="CashInConfirmNew1"> <img src="/DrcbDocs/assets/img/CashInConfirmNew2.c4b3706e.png" alt="CashInConfirmNew2"></p> <h3 id="注意点-可能的扩展改造"><a href="#注意点-可能的扩展改造" aria-hidden="true" class="header-anchor">#</a> 注意点&amp;可能的扩展改造</h3> <h4 id="交割类型"><a href="#交割类型" aria-hidden="true" class="header-anchor">#</a> 交割类型</h4> <p>现金交割类型分四种，根据DELIVERYTYPE字段（01 全机具收付 02 机具+PAD 03 网点收付 04 PAD收付）判断。
过去曾在一个BUSISTEP下，由一个页面完成所有交割类型的存款功能。
现已拆分为多个步骤，当前页面仅机具存款。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">onNavigated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;DELIVERYTYPE&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;03&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tipMsg <span class="token operator">=</span> <span class="token string">&quot;稍后前往柜台进行现金交付记账&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCashIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>当实收小于应收且用户选择柜员协助收取时，DELIVERYTYPE需要改成02。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Dialog<span class="token punctuation">.</span><span class="token function">showAwait</span><span class="token punctuation">(</span>RealNameCheckDialog<span class="token punctuation">,</span> <span class="token punctuation">{</span>
   dialogBoxContentArgs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
     tipMessage<span class="token punctuation">:</span> <span class="token string">&quot;实收金额小于应收金额,是否需要现场柜员协助收取？&quot;</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>deliveryType <span class="token operator">=</span> <span class="token string">&quot;02&quot;</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="存款流程"><a href="#存款流程" aria-hidden="true" class="header-anchor">#</a> 存款流程</h4> <p>确定交割类型是机具收取后，检查设备状态是否故障，钞口是否有钞票。
为了避免其他人上一笔交易的现金留在钞口被其他人取走，钞口如有异物一律不得开门，需报错提示终止交易。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">initCashIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//检查设备状态及钞口异物</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//检查是否有业务需求的传感器</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBanknoteTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//获取设备支持的币种类型</span>
    <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCashUnitInfo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//存款开始前记录钞箱信息</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//绑定监听的事件</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cashInStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启存款</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>点钞（CashIn）动作(可多次进行)必须运行在开启存款（CashInStart）之后，结束存款（CashInEnd）之前。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">cashInStartAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCashInLimitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启存款成功后设置限额</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">openCashInShutter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启存款成功后才能打开钞门</span>
<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">cashInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">cashInEndAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="限额"><a href="#限额" aria-hidden="true" class="header-anchor">#</a> 限额</h4> <p>云柜台存款会设置一个限额，避免用户存入钞箱过多金额。</p> <ol><li><strong>第一次</strong>设置限额是<strong>机具应收金额</strong>。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>machReceivable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;MACHPREAMOUNT&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machReceivable；
<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">setCashInLimitAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  TotalItemsLimit<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//张数默认0不设限制</span>
  AmountLimit<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    CurrencyID<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//[67, 78, 89]是人民币CNY的ASCII</span>
    Amount<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li><strong>第二次</strong>设置限额避免继续存款时金额超过<strong>二类户限额</strong>或<strong>核身限额</strong>或<strong>单笔限额</strong></li></ol> <p>坐席录入金额时也会检测可存金额，故只有当用户存入机具金额已达到限额，且用户选择继续存款时，才会<strong>第二次</strong>设置限额。</p> <p>如果存在则取二类户累计限额（最多1万元）或核身限额（通常5万元），否则限额改成20万（单笔限额）。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>machineGather <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machReceivable<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果实收已等于应收</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Dialog<span class="token punctuation">.</span><span class="token function">showAwait</span><span class="token punctuation">(</span>RealNameCheckDialog<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    dialogBoxContentArgs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      tipMessage<span class="token punctuation">:</span> <span class="token string">&quot;实收金额已等于应收金额,是否仍继续放钞？&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//用户选择继续存款，则重新设置限额</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transferLimitAmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transferLimitAmount<span class="token punctuation">;</span> <span class="token comment">//二类户累计限额</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minValidNote<span class="token punctuation">;</span> <span class="token comment">//核身限额</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount <span class="token operator">=</span> <span class="token number">200000</span><span class="token punctuation">;</span> <span class="token comment">//单笔限额</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCashInLimitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canResume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//取消继续存款按钮</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>二类户累计限额</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;ACCT_TYPE&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 二类户累计限额一定小于核身限额，且存款可等于累积限额</span>
  <span class="token keyword">let</span> limitValueList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token string">&quot;DAY,MON,YEAR&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IN_TRANSFER_LIMIT`</span></span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
      limitValueList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IN_TRANSFER_LIMIT`</span></span><span class="token punctuation">)</span> <span class="token operator">-</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IN_OCCUR_AMT`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>transferLimitAmount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">...</span>limitValueList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取年、月、日累计限额减去发生额的三个结果的最小值</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>核身限额</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;CHECKIDAMOUNT&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machReceivable <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//如果机具应收超过核身限额，则说明已核身</span>
</code></pre></div><p>因存款金额只能小于不能等于核身限额，所以限额设置为核身限额减去最小可收取面额。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;DENOMINATION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//支持面额，字段值格式为&quot;100|50|20|10|5|1&quot;</span>
  <span class="token keyword">let</span> denominationList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;DENOMINATION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>minValidNote <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">...</span>denominationList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>limitAmount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkIDAmount <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minValidNote<span class="token punctuation">;</span>
</code></pre></div><h4 id="事件"><a href="#事件" aria-hidden="true" class="header-anchor">#</a> 事件</h4> <p>现金存款过程中，常见的几个事件有：</p> <ul><li><code>ItemsInsertedEventListener</code> 存款口有钞票放入。</li> <li><code>InputRefuseEventListener</code> 点钞后有拒钞。</li> <li><code>ItemsTakenEventListener</code> 存款口或取款口的钞票被<strong>全部</strong>拿走。</li> <li><code>MediaDetectedEventListener</code> 设备复位后检测到物件存留在机器中。</li> <li><code>CashUnitThresholdEventListener</code> 回收钞箱满时触发。（部分厂商每次钞箱状态变化时也会触发）。</li></ul> <p>在初始化时监听事件后，页面关闭时一定要取消监听。否则后续会一次事件多次触发导致异常。</p> <h4 id="点钞异常"><a href="#点钞异常" aria-hidden="true" class="header-anchor">#</a> 点钞异常</h4> <p>在用户放入钞票后，就可以点击点钞按钮，开始点钞。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cashInResult <span class="token operator">=</span> <span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">cashInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMoneyInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cashInResult<span class="token punctuation">.</span>NoteNumber<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//点钞成功则展示存款信息</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cashInExceptionHandleAsync</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//否则进行异常处理</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>包括点钞异常在内，存款页面中所有异常，最终都会进行异常处理：</p> <ol><li>存款口吞钞。(避免下笔交易钞口有钞票，取款口吞钞硬件不支持)</li> <li>登记异常吞钞接口。</li> <li>登记异常簿登记。</li> <li>推送A端异常信息，打印异常小票。</li> <li>重置设备。（避免下笔交易设备异常）</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">retractAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Q029</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span>ExceptionMemo <span class="token operator">=</span> errorMsg<span class="token punctuation">;</span> <span class="token comment">//异常描述</span>
request<span class="token punctuation">.</span>CardNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno<span class="token punctuation">;</span> <span class="token comment">//卡号或一本通账号</span>
request<span class="token punctuation">.</span>Amount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machineGather<span class="token punctuation">;</span> <span class="token comment">//吞钞金额</span>
<span class="token keyword">await</span> RequestHelper<span class="token punctuation">.</span><span class="token function">sendAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">excpRegistrationAsync</span><span class="token punctuation">(</span><span class="token string">&quot;CashIn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cashInAsync&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CashInError&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pushAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token constant">ERRORCODE</span><span class="token punctuation">:</span> <span class="token string">&quot;999999&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">ERRORMSG</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errorMsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">。`</span></span><span class="token punctuation">,</span>
    <span class="token constant">ERRORAMOUNT</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machineGather<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">MMDATE</span><span class="token punctuation">:</span> Moment<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;hh:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">FLOWNAME</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;FLOWNAME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">PAYERACCNO</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno<span class="token punctuation">,</span>
    <span class="token constant">ACTAMOUNT</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>machReceivable<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">COUNT</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>errorCount <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>errorCount <span class="token operator">+</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;0002&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CashInException&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">resetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="冠字号"><a href="#冠字号" aria-hidden="true" class="header-anchor">#</a> 冠字号</h4> <p>冠字号是钞票上，用来验真伪的序列号。需要记录入库并上传到V端供查阅。</p> <p>在点钞等钞票移动的时候，钞票会经过钞箱的BV模块，此时会被记录到冠字号数值和照片。</p> <p>C端此时要记录其他信息匹配对应冠字号保存下来。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token constant">REQ_BODY</span><span class="token punctuation">.</span><span class="token constant">TASKID</span><span class="token punctuation">,</span> <span class="token comment">//交易流水号</span>
  <span class="token string">&quot;吞钞&quot;</span><span class="token punctuation">,</span> <span class="token comment">//交易类型</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno <span class="token operator">||</span> <span class="token string">&quot;?????????????&quot;</span><span class="token punctuation">,</span> <span class="token comment">//卡号</span>
  <span class="token string">&quot;异常吞钞&quot;</span><span class="token punctuation">,</span> <span class="token comment">//现金过程</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>SysHead<span class="token punctuation">.</span>TdgBrah<span class="token punctuation">,</span> <span class="token comment">//机构号</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>DeviceInfo<span class="token punctuation">.</span>DeviceNum <span class="token comment">//设备号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>冠字号需要的卡号，不同交易P端提供的字段（PAYEEACCNO或PAYERACCNO）不同，新增现金交易一定要确认清楚。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getAccNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> flowID <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;FLOWID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flowID <span class="token operator">==</span> <span class="token string">&quot;REVERTRADE&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> originalFlowID <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;YGT_TRADEDATA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">FLOWID</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> flowAccNOMap <span class="token operator">=</span> <span class="token punctuation">{</span>
      CashDeposit<span class="token punctuation">:</span> <span class="token string">&quot;PAYEEACCNO&quot;</span><span class="token punctuation">,</span>
      FixedAcctCancel<span class="token punctuation">:</span> <span class="token string">&quot;PAYERACCNO&quot;</span><span class="token punctuation">,</span>
      CashWithdrawal<span class="token punctuation">:</span> <span class="token string">&quot;PAYERACCNO&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">// PerlInBankTransfer 转账不会有机具操作</span>
      <span class="token comment">// CorpInBankTransfer 转账不会有机具操作</span>
      CompanyDeposits<span class="token punctuation">:</span> <span class="token string">&quot;PAYEEACCNO&quot;</span><span class="token punctuation">,</span>
      CompanyWithdraw<span class="token punctuation">:</span> <span class="token string">&quot;PAYERACCNO&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>flowAccNOMap<span class="token punctuation">[</span>originalFlowID<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flowID <span class="token operator">==</span> <span class="token string">&quot;RuralCreditBankTC&quot;</span> <span class="token operator">||</span> flowID <span class="token operator">==</span> <span class="token string">&quot;CreditBankToCust&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;PAYEEACCNO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>payerAccno <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;PAYERACCNO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>保存后会汇总到应用根目录下（D:/dotnet/）的Crown文件夹里当天的Crown.txt中。</p> <p><img src="/DrcbDocs/assets/img/Crown1.113c2808.png" alt="Crown1"> <img src="/DrcbDocs/assets/img/Crown2.9de6688a.png" alt="Crown2"></p> <p>存款过程中，通常有3个动作发生现金移动，读到冠字号。</p> <ol><li>存款点钞动作 CashIn</li> <li>存款口吞钞动作 Retract</li> <li>复位动作 reset</li></ol> <p>目前厂商SP会在每次产生冠字号时，清空上一次保存的冠字号，所以应用也需要及时保存相应数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">cashInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">retractAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> CashIn<span class="token punctuation">.</span><span class="token function">resetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>每次保存冠字号后，AFileServer和AAgent都会在应用根目录下（D:/dotnet/）的AgentUpdateCrown文件夹里打包该次的冠字号信息和冠字号图片，并上传。上传失败的冠字号会留在文件夹里，继续上传。</p> <p>上传日志会记录在应用根目录下（D:/dotnet/）的Log文件夹里当天的FileUpload.txt中。</p> <p><img src="/DrcbDocs/assets/img/FileUploadTxt.de14f9a2.png" alt="FileUploadTxt"></p> <h2 id="cashoutayo-机具取款页面"><a href="#cashoutayo-机具取款页面" aria-hidden="true" class="header-anchor">#</a> CashOutAyo 机具取款页面</h2> <h3 id="简易流程图-2"><a href="#简易流程图-2" aria-hidden="true" class="header-anchor">#</a> 简易流程图</h3> <p><img src="/DrcbDocs/assets/img/CashOutAyo.b162398f.png" alt="CashOutAyo"></p> <h3 id="注意点-可能的扩展改造-2"><a href="#注意点-可能的扩展改造-2" aria-hidden="true" class="header-anchor">#</a> 注意点&amp;可能的扩展改造</h3> <p>取款的交割类型和流程与存款类似。
根据DELIVERYTYPE字段（01 全机具收付 02 机具+PAD 03 网点收付 04 PAD收付）判断交割类型。</p> <h4 id="冠字号-2"><a href="#冠字号-2" aria-hidden="true" class="header-anchor">#</a> 冠字号</h4> <p>取款需要先配钞，再出钞。开关门控制由厂商SP控制。
在<code>dispenseAsync</code>出钞方法参数里传<code>present:true</code>让厂商控制开门时，因恒银厂商出钞失败会记录不到冠字号。
故由应用控制<code>presentAsync</code>开门,<code>dispenseAsync</code>后立刻存冠字号。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> CashDispenser<span class="token punctuation">.</span><span class="token function">denominateAsync</span><span class="token punctuation">(</span>cashDenominateParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> CashDispenser<span class="token punctuation">.</span><span class="token function">dispenseAsync</span><span class="token punctuation">(</span>cashDispenseParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> CashDispenser<span class="token punctuation">.</span><span class="token function">presentAsync</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>取款存冠字号时机为出钞成功后，出钞失败后，设备复位后。
为了兼容各个厂商SP记录冠字号的特性，需要避免取款冠字号重复记录。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span><span class="token punctuation">{</span>
  <span class="token keyword">await</span> CashDispenser<span class="token punctuation">.</span><span class="token function">dispenseAsync</span><span class="token punctuation">(</span>cashDispenseParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hasSavedSNR <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token operator">!</span>hasSavedSNR <span class="token operator">&amp;&amp;</span> <span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> CashDispenser<span class="token punctuation">.</span><span class="token function">resetAsync</span><span class="token punctuation">(</span>resetParams<span class="token punctuation">)</span>
  <span class="token operator">!</span>hasSavedSNR <span class="token operator">&amp;&amp;</span> <span class="token keyword">await</span> SystemOperateManager<span class="token punctuation">.</span><span class="token function">saveSNRInfoFileAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="事件-2"><a href="#事件-2" aria-hidden="true" class="header-anchor">#</a> 事件</h4> <p>现金取款过程中，与存款不同的的几个事件有：</p> <ul><li><code>PartialDispenseEventListener</code> 取款超过1万元需多次出钞时触发。</li> <li><code>ItemsPresentedEventListener</code> 打开钞门钞票呈现给用户时触发。</li> <li><code>SubDispenseOkEventListener</code> 大额多次取款时每次出钞成功后触发。和present相似，但参数里包含单词出钞金额。</li></ul> <h4 id="大额取款"><a href="#大额取款" aria-hidden="true" class="header-anchor">#</a> 大额取款</h4> <p>当取款金额超过1万元时，机具会分多次出钞，每次最多出1万元。
为了准确记录异常时，大额取款已出钞金额，会记录出钞次数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>preTakenManyTimes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;MACHPREAMOUNT&quot;</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">//预计出钞次数</span>
<span class="token function">onItemsTakenEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>takenManyTimes<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//每次用户取走出钞后，已取次数＋1</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>preTakenManyTimes <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takenManyTimes <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitAsync</span><span class="token punctuation">(</span><span class="token constant">MACHACTAMOUNT</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takenManyTimes <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//异常时，已取次数小于预出次数，提交的取款金额根据已出次数计算。</span>
</code></pre></div><h4 id="取款异常"><a href="#取款异常" aria-hidden="true" class="header-anchor">#</a> 取款异常</h4> <p>取款流程和存款不一样，是先记账成功，后出钞。
所以即使取款异常，也需要提交P端继续流程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">excepDeal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;对不起，因设备故障出钞异常，请持打印凭条联系现场人员处理&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">&quot;delay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//为了处理C端同时受到异常小票和电子凭证报文而设置的事件</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onOK</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//提交取款</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">excpRegistration</span><span class="token punctuation">(</span> <span class="token comment">//登记异常登记簿</span>
    <span class="token string">&quot;CashDispenser&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dispenseAsync&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;CashOutdispenseAsync&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通知A端打印异常小票</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>提交P的同时，推送了A异常信息。所以C端会同时收到多个报文消息(ElecVoucherCreatePdf, TakeNotes_1, <em>SHOWTIME</em>)。
为了避免页面互相顶掉，按先打小票，后生成电子凭证的顺序，在父组件<code>PageContainerNavigator</code>里订阅了一个delay事件（<code>@delay=&quot;ondelayEvent&quot;</code>），在取款页面触发异常时，发布此事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//已下是父组件PageContainerNavigator</span>
<span class="token function">ondelayEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>needDelay <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>delayEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">async</span> <span class="token function">onOpenPage</span><span class="token punctuation">(</span><span class="token parameter">pageInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//报文OPENPAGE事件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>needDelay <span class="token operator">&amp;&amp;</span> pageInfo<span class="token punctuation">.</span><span class="token constant">REQ_BODY</span><span class="token punctuation">.</span><span class="token constant">PAGETYPE</span> <span class="token operator">==</span> <span class="token string">&quot;ElecVoucherCreatePdf&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needDelay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tempPageInfo <span class="token operator">=</span> pageInfo<span class="token punctuation">;</span> <span class="token comment">//电子凭证报文先临时存放起来</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  pagePath <span class="token operator">=</span> TradeFlower<span class="token punctuation">[</span>pageInfo<span class="token punctuation">.</span><span class="token constant">REQ_BODY</span><span class="token punctuation">.</span><span class="token constant">PAGENO</span><span class="token punctuation">]</span><span class="token punctuation">[</span>pageInfo<span class="token punctuation">.</span><span class="token constant">REQ_BODY</span><span class="token punctuation">.</span><span class="token constant">BUSISTEP</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentPage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token function">openPage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">PAGENO</span><span class="token punctuation">,</span> <span class="token constant">BUSISTEP</span><span class="token punctuation">,</span> pageInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//子组件this.$emit(&quot;openPage&quot;)事件</span>
  <span class="token comment">//异常小票打印完毕后，会推送openPage</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delayEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onOpenPage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tempPageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//此时再打开电子凭证</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeCurrentPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  pagePath <span class="token operator">=</span> TradeFlower<span class="token punctuation">[</span><span class="token constant">PAGENO</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">BUSISTEP</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentPage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/DrcbDocs/modules/Receipt.html" class="prev">
          凭条模块
        </a></span> <span class="next"><a href="/DrcbDocs/modules/HighCamera.html">
          高拍仪模块
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/DrcbDocs/assets/js/app.5f05759d.js" defer></script><script src="/DrcbDocs/assets/js/22.afd303ac.js" defer></script>
  </body>
</html>
